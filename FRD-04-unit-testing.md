# ðŸ§ª Functional Requirements Document (FRD-04)

**Project:** Boilerplate NestJS CRUD Products  
**Document:** Minimum Unit Tests for Products Module  
**Version:** v1.0  
**Author:** Jorge Gomez  
**Status:** Draft

---

## 1. Purpose

1.1 Define the **minimum set of unit tests** that **must exist** for the `products` module in the NestJS backend generated by the previous FRDs (FRD-01 and FRD-02).

1.2 Ensure that these tests:

- Validate the core business behavior of the `ProductsService` and `ProductsController`.  
- Are **fast, deterministic and isolated** (they must not touch a real database).  
- Can be executed with a single command:

```bash
npm test
```

## 1.3 Purpose

This FRD does **not** aim for full coverage, but for a **minimal, robust base** of unit tests for the `products` module.  
These tests **must** be executable with a dedicated command:

```bash
npm run test:products
```

---

## 2. Scope

### 2.1 In-Scope

- Unit tests for:
  - `products.service.ts`
  - `products.controller.ts`
- Use of:
  - **Jest** as the test runner.
  - `@nestjs/testing` to build the `TestingModule`.
  - **Mocked repositories** to simulate database access.
- Validation of:
  - Correct interaction between controller and service.
  - Correct interaction between service and repository.
  - Proper handling of success and error scenarios.

### 2.2 Out-of-Scope

- End-to-end (e2e) tests.  
- Integration tests against a **real database**.  
- Coverage thresholds (no minimum coverage percentage required).  
- Performance, load or stress tests.

---

## 3. Related Documents

3.1 **FRD-01 â€” Boilerplate Core Products**  
File: `FRD-01-boilerplate-core-products.md`  
Role: Defines the base NestJS project, in-memory `Product` CRUD, DTOs, validation and Swagger.

3.2 **FRD-02 â€” Products Database (TypeORM + Migrations)**  
File: `FRD-02-products-database.md`  
Role: Extends the project to use a real database with TypeORM, a dedicated repository and migrations.

This FRD (FRD-04) depends on the existence of:

- A working `ProductsService` using TypeORM.  
- A working `ProductsController` exposing the CRUD endpoints.

---

## 4. Global Testing Guidelines

### 4.1 All tests must be implemented using:

- **Jest** (preconfigured by NestJS).  
- `@nestjs/testing` (TestingModule).

A dedicated npm script **must** be created in `package.json`:

```jsonc
"scripts": {
  "test": "jest",
  "test:products": "jest src/products"
}
```

The `test:products` script is the one referenced by this FRD and is considered the **authoritative command** for Phase 4.

4.2 The tests **must not**:

- Connect to a real database.  
- Use the actual TypeORM configuration.  
- Hit HTTP endpoints (those would be e2e tests, out of scope here).

4.3 Repository access must be **fully mocked**, using patterns similar to:

```ts
const mockProductRepository = {
  find: jest.fn(),
  findOne: jest.fn(),
  save: jest.fn(),
  update: jest.fn(),
  delete: jest.fn(),
};
```

4.4 The `TestingModule` must inject the mock repository instead of the real one, for example:

```ts
{
  provide: getRepositoryToken(Product),
  useValue: mockProductRepository,
}
```

4.5 Each test must clearly express **one behavior** and use descriptive names, for example:

- `should create a product successfully`  
- `should throw NotFoundException when product does not exist`

4.6 Tests must be **idempotent**: running them multiple times should always yield the same result.

---

## 5. Unit Tests for ProductsService

The following test cases are mandatory for `products.service.spec.ts`.

### 5.1 S-01 â€” Create Product Successfully

- **Given** a valid `CreateProductDto`.  
- **When** `ProductsService.create(dto)` is called.  
- **Then** it must:
  - Call `repository.save()` with the correct data.  
  - Return the created product (including its `id`).

### 5.2 S-02 â€” Get All Products

- **When** `ProductsService.findAll()` is called.  
- **Then** it must:
  - Call `repository.find()`.  
  - Return an array of products (possibly empty).

### 5.3 S-03 â€” Get One Product by ID (Success)

- **Given** an existing product ID.  
- **When** `ProductsService.findOne(id)` is called.  
- **Then** it must:
  - Call `repository.findOne({ where: { id } })`.  
  - Return the corresponding product.

### 5.4 S-04 â€” Get One Product by ID (Not Found)

- **Given** a non-existing product ID.  
- **When** `ProductsService.findOne(id)` is called and the repository returns `null` or `undefined`.  
- **Then** it must:
  - Throw a `NotFoundException` with a meaningful message.

### 5.5 S-05 â€” Update Product Successfully

- **Given** an existing product ID and a valid update DTO.  
- **When** `ProductsService.update(id, dto)` is called.  
- **Then** it must:
  - Call the repository methods required to update the product (for example, `findOne` and `save` or `update`).  
  - Return the updated product.

### 5.6 S-06 â€” Delete Product Successfully

- **Given** an existing product ID.  
- **When** `ProductsService.remove(id)` is called.  
- **Then** it must:
  - Call the repository method to delete the product (`delete` or equivalent).  
  - Return an appropriate result (for example, `void` or a confirmation object).

---

## 6. Unit Tests for ProductsController

The following test cases are mandatory for `products.controller.spec.ts`.

In all cases, the service must be **mocked**, and the controller must delegate correctly.

### 6.1 C-01 â€” Create Product (Controller â†’ Service)

- **When** `ProductsController.create(dto)` is called.  
- **Then** it must:
  - Call `ProductsService.create(dto)`.  
  - Return whatever the service returns.

### 6.2 C-02 â€” Get All Products

- **When** `ProductsController.findAll()` is called.  
- **Then** it must:
  - Call `ProductsService.findAll()`.  
  - Return the list provided by the service.

### 6.3 C-03 â€” Get Product by ID

- **When** `ProductsController.findOne(id)` is called.  
- **Then** it must:
  - Call `ProductsService.findOne(id)` with the same `id`.  
  - Return the product returned by the service.

### 6.4 C-04 â€” Update Product

- **When** `ProductsController.update(id, dto)` is called.  
- **Then** it must:
  - Call `ProductsService.update(id, dto)`.  
  - Return the updated product returned by the service.

### 6.5 C-05 â€” Delete Product

- **When** `ProductsController.remove(id)` is called.  
- **Then** it must:
  - Call `ProductsService.remove(id)`.  
  - Return the result from the service (or nothing, according to the implementation).

---

## 7. Test Execution

7.1 The project **must** be able to run all **products module** unit tests with:

```bash
npm run test:products
```

7.2 The tests defined in this FRD must:

- Execute without runtime errors.  
- Pass consistently on every execution.  
- Not depend on environment variables related to the real database.  
- Not require any other moduleâ€™s tests (e.g., `auth`, `users`) to be green.

7.3 If additional tests are added for other modules (such as `auth` or `users`), their success or failure is **out of scope** for this FRD and must be handled by their own future FRDs.

---

## 8. Acceptance Criteria

For FRD-04 to be considered **fulfilled**, the following conditions must be met:

1. The files `products.service.spec.ts` and `products.controller.spec.ts` exist.  
2. Each file includes the test cases defined in sections **5** and **6** (S-01 to S-06, C-01 to C-05).  
3. **All tests for the `products` module pass when running:**

   ```bash
   npm run test:products
   ```

4. No test attempts to connect to a real database.  
5. The mocks used in the tests are **explicit and controlled**.  
6. The tests document the expected behavior of the `products` module clearly and readably.

Once these criteria are met, the unit testing layer for the `products` module will be considered complete according to FRD-04.
